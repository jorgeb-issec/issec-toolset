{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">IS Analyzer</h1>
            <p class="text-muted small">Plataforma de análisis de seguridad, topología y cumplimiento Zero Trust</p>
        </div>
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="actionsDropdown"
                    data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear"></i> Acciones
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsDropdown">
                    <li><button class="dropdown-item text-danger" onclick="confirmDeleteLogs()">
                            <i class="bi bi-trash me-2"></i>Eliminar Todos los Logs
                        </button></li>
                    <li><button class="dropdown-item text-warning" onclick="confirmDeleteRecommendations()">
                            <i class="bi bi-eraser me-2"></i>Eliminar Recomendaciones
                        </button></li>
                </ul>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importLogsModal">
                <i class="bi bi-upload"></i> Importar Logs
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4" id="stats-container">
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Total Logs</h6>
                    <h2 class="mb-0" id="stat-total-logs">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm border-start border-danger border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Amenazas/Denied</h6>
                    <h2 class="mb-0 text-danger" id="stat-threats">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Aceptados</h6>
                    <h2 class="mb-0 text-success" id="stat-accepted">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 border-0 shadow-sm border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small">Recomendaciones AI</h6>
                    <h2 class="mb-0 text-warning" id="stat-recommendations">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Breakdown -->
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-uppercase text-muted fw-bold">Detalle de Acciones (Total)</small>
                <small class="text-muted" style="font-size: 0.7em;">Todos los eventos registrados</small>
            </div>
            <div class="d-flex flex-wrap gap-2" id="actions-breakdown">
                <span class="text-muted small">Cargando detalles...</span>
            </div>
        </div>
    </div>

    <!-- Global Filters -->
    <div class="card mb-4 border-0 shadow-sm bg-light">
        <div class="card-body py-2">
            <form id="global-filter-form" class="row g-2 align-items-center justify-content-between">
                <div class="col-auto d-flex align-items-center">
                    <label class="small fw-bold text-muted me-2"><i class="bi bi-hdd-network"></i> Dispositivo:</label>
                    <select class="form-select form-select-sm" name="device_id" id="global-device-select"
                        style="min-width: 200px;" onchange="currentPage=1; loadLogs();">
                        <option value="">Todos los Equipos</option>
                        {% for d in devices %}
                        <option value="{{ d.id }}">{{ d.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto d-flex align-items-center">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0" name="search" id="global-search-input"
                            placeholder="Buscar IP, usuario, política..."
                            onkeyup="if(event.key === 'Enter') { currentPage=1; loadLogs(); }">
                        <button type="button" class="btn btn-primary"
                            onclick="currentPage=1; loadLogs()">Filtrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <ul class="nav nav-tabs mb-3" id="logTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                type="button">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="static-audit-tab" data-bs-toggle="tab" data-bs-target="#static-audit"
                type="button">Static Audit</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="dynamic-audit-tab" data-bs-toggle="tab" data-bs-target="#dynamic-audit"
                type="button">Dynamic Audit</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="explorer-tab" data-bs-toggle="tab" data-bs-target="#explorer" type="button">Log
                Explorer</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="topology-tab" data-bs-toggle="tab" data-bs-target="#topology" type="button">
                Topology
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config" type="button">
                <i class="bi bi-gear"></i> Configuración
            </button>
        </li>
    </ul>

    <div class="tab-content" id="logTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <!-- ... existing overview ... -->
            <div class="row">
                <div class="col-md-12">
                    <div class="alert alert-info">
                        <h4 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Bienvenido a IS Analyzer</h4>
                        <p>Seleccione una pestaña para comenzar el análisis. Use el selector de
                            <strong>Dispositivo</strong> arriba para filtrar el contexto.
                        </p>
                        <hr>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary"
                                onclick="document.getElementById('static-audit-tab').click()">
                                <i class="bi bi-search me-2"></i>Auditoría Estática
                            </button>
                            <button class="btn btn-outline-success"
                                onclick="document.getElementById('dynamic-audit-tab').click()">
                                <i class="bi bi-activity me-2"></i>Auditoría Dinámica
                            </button>
                            <button class="btn btn-outline-dark"
                                onclick="document.getElementById('explorer-tab').click()">
                                <i class="bi bi-list-columns me-2"></i>Log Explorer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Stats Cards will be here -->
            <!-- Stats moved to global top bar -->
        </div>

        <!-- Static Audit Tab -->
        <div class="tab-pane fade" id="static-audit" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 text-primary"><i class="bi bi-shield-check me-2"></i>Auditoría Estática
                        (Configuración)</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadStaticAudit()">
                        <i class="bi bi-arrow-clockwise"></i> Ejecutar Análisis
                    </button>
                </div>
                <!-- Top Pagination -->
                <div class="card-footer bg-white d-flex justify-content-between align-items-center border-bottom">
                    <div class="d-flex align-items-center">
                        <span class="text-muted small me-2" id="static-pagination-info-top">Mostrando 0-0 de 0</span>
                        <select class="form-select form-select-sm rec-per-page-select" style="width: 80px;"
                            onchange="changeRecPerPage(this.value)">
                            <option value="8">8</option>
                            <option value="16">16</option>
                            <option value="32" selected>32</option>
                            <option value="64">64</option>
                            <option value="128">128</option>
                            <option value="256">256</option>
                            <option value="512">512</option>
                        </select>
                        <span class="text-muted small ms-1">filas</span>
                    </div>
                    <ul class="pagination pagination-sm mb-0 rec-pagination-controls"></ul>
                </div>
                <div class="card-body" id="static-audit-container">
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-search fs-1 mb-3 d-block"></i>
                        <p>Haga clic en "Ejecutar Análisis" para buscar vulnerabilidades en la configuración.</p>
                    </div>
                </div>
                <!-- Bottom Pagination -->
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <span class="text-muted small" id="static-pagination-info-bottom">Mostrando 0-0 de 0</span>
                    <ul class="pagination pagination-sm mb-0 rec-pagination-controls"></ul>
                </div>
            </div>
        </div>

        <!-- Dynamic Audit Tab -->
        <div class="tab-pane fade" id="dynamic-audit" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 text-success"><i class="bi bi-activity me-2"></i>Auditoría Dinámica (Log-Based)</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportRecommendations('all', 'csv')">CSV</a>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="exportRecommendations('all', 'pdf')">PDF</a>
                            </li>
                        </ul>
                        <button class="btn btn-outline-success" onclick="runDynamicAudit()">
                            <i class="bi bi-play-fill"></i> Ejecutar Análisis
                        </button>
                    </div>
                </div>
                <!-- Top Pagination -->
                <div class="card-footer bg-white d-flex justify-content-between align-items-center border-bottom">
                    <div class="d-flex align-items-center">
                        <span class="text-muted small me-2" id="dynamic-pagination-info-top">Mostrando 0-0 de 0</span>
                        <select class="form-select form-select-sm rec-per-page-select" style="width: 80px;"
                            onchange="changeRecPerPage(this.value)">
                            <option value="8">8</option>
                            <option value="16">16</option>
                            <option value="32" selected>32</option>
                            <option value="64">64</option>
                            <option value="128">128</option>
                            <option value="256">256</option>
                            <option value="512">512</option>
                        </select>
                        <span class="text-muted small ms-1">filas</span>
                    </div>
                    <ul class="pagination pagination-sm mb-0 rec-pagination-controls"></ul>
                </div>
                <div class="card-body" id="dynamic-audit-container">
                    <!-- Results will load here -->
                    <div class="text-center py-5 text-muted">
                        <div class="spinner-border text-success mb-3 d-none" role="status" id="dynamic-spinner"></div>
                        <p>Análisis de Zombies, Least Privilege y Noisy Drops.</p>
                    </div>
                </div>
                <!-- Bottom Pagination -->
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <span class="text-muted small" id="dynamic-pagination-info-bottom">Mostrando 0-0 de 0</span>
                    <ul class="pagination pagination-sm mb-0 rec-pagination-controls"></ul>
                </div>
            </div>
        </div>

        <!-- Log Explorer Tab (Formerly Active) -->
        <div class="tab-pane fade" id="explorer" role="tabpanel">
            <div class="card shadow-sm">
                <!-- Removed local search header -->
                <div class="card-footer bg-white d-flex justify-content-between align-items-center border-bottom">
                    <div class="d-flex align-items-center">
                        <span class="text-muted small me-2" id="pagination-info-top">Mostrando 0-0 de 0</span>
                        <select class="form-select form-select-sm per-page-select" style="width: 80px;"
                            onchange="changePerPage(this.value)">
                            <option value="8">8</option>
                            <option value="16">16</option>
                            <option value="32" selected>32</option>
                            <option value="64">64</option>
                            <option value="128">128</option>
                            <option value="256">256</option>
                            <option value="512">512</option>
                        </select>
                        <span class="text-muted small ms-2">filas</span>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination-controls-top">
                        </ul>
                    </nav>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 text-nowrap align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Level</th>
                                    <th>VDOM</th>
                                    <th>Type</th>
                                    <th>Src IP</th>
                                    <th>Dst IP</th>
                                    <th>Service</th>
                                    <th>Action</th>
                                    <th>App</th>
                                    <th><i class="bi bi-gear"></i></th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body">
                                <tr>
                                    <td colspan="10" class="text-center py-4 text-muted">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="text-muted small me-2" id="pagination-info-bottom">Mostrando 0-0 de 0</span>
                        <select class="form-select form-select-sm per-page-select" style="width: 80px;"
                            onchange="changePerPage(this.value)">
                            <option value="8">8</option>
                            <option value="16">16</option>
                            <option value="32" selected>32</option>
                            <option value="64">64</option>
                            <option value="128">128</option>
                            <option value="256">256</option>
                            <option value="512">512</option>
                        </select>
                        <span class="text-muted small ms-2">filas</span>
                    </div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination-controls-bottom">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>



        <!-- Topology Tab -->
        <div class="tab-pane fade" id="topology" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 text-primary"><i class="bi bi-diagram-3-fill me-2"></i>Topología de Red</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="topology-site-filter" style="width: 200px;"
                            onchange="loadTopology()">
                            <option value="">Todos los Sitios</option>
                            {% for s in sites %}
                            <option value="{{ s.id }}">{{ s.nombre }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-select form-select-sm" id="topology-mode" style="width: 150px;">
                            <option value="dynamic">Modo: Dinámico</option>
                            <option value="saved">Modo: Guardado</option>
                        </select>
                        <button class="btn btn-sm btn-outline-success" onclick="saveTopology()">
                            <i class="bi bi-save"></i> Guardar
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="analyzeTopology()">
                            <i class="bi bi-magic"></i> Analizar
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleTopologyView()"
                            title="Cambiar a vista Texto">
                            <i class="bi bi-file-text"></i> Texto
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadTopology()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="topology-network"
                        style="height: 600px; width: 100%; position: relative; background-color: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status"></div>
                                <p>Cargando visualización de infraestructura...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-3 small text-muted">
                            <span class="d-flex align-items-center"><i class="bi bi-circle-fill text-danger me-1"></i>
                                Site</span>
                            <span class="d-flex align-items-center"><i
                                    class="bi bi-hdd-network-fill text-primary me-1"></i>
                                Device</span>
                            <span class="d-flex align-items-center"><i class="bi bi-hexagon-fill text-success me-1"></i>
                                VDOM</span>
                            <span class="d-flex align-items-center"><i class="bi bi-link text-secondary me-1"></i>
                                Interface</span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#topologyDebug" aria-expanded="false" aria-controls="topologyDebug">
                                <i class="bi bi-code-slash me-1"></i> Debug JSON
                            </button>
                        </div>
                    </div>

                    <div class="collapse mt-3" id="topologyDebug">
                        <div class="card card-body bg-dark text-light font-monospace small"
                            style="max-height: 300px; overflow-y: auto;">
                            <pre id="topology-json-output" class="m-0 text-success">Esperando datos...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Tab -->
        <div class="tab-pane fade" id="config" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-key me-2"></i>Configuración de AI (Gemini)</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info small">
                                <i class="bi bi-info-circle me-2"></i>
                                Para usar el análisis de seguridad con IA, necesitas una API Key de Google Gemini.
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="alert-link">
                                    Obtener API Key <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </div>

                            <form id="gemini-config-form">
                                <div class="mb-3">
                                    <label class="form-label">Gemini API Key</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-key"></i></span>
                                        <input type="password" class="form-control" name="gemini_api_key"
                                            id="gemini-api-key" placeholder="AIzaSy...">
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="toggleApiKeyVisibility()">
                                            <i class="bi bi-eye" id="eye-icon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        La API Key se guardará de forma segura en la configuración de tu empresa.
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="btn-save-config">
                                    <i class="bi bi-check-lg me-1"></i>Guardar Configuración
                                </button>
                            </form>

                            <hr class="my-4">

                            <h6 class="mb-3">Estado de Configuración</h6>
                            <div id="config-status">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge bg-secondary me-2" id="api-key-status">Verificando...</span>
                                    <span class="small text-muted">API Key de Gemini</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Ayuda</h5>
                        </div>
                        <div class="card-body">
                            <h6>¿Cómo funciona el análisis AI?</h6>
                            <p class="small text-muted">
                                Cuando importas logs, el sistema puede enviar estadísticas y patrones a la IA de Google
                                (Gemini) para generar recomendaciones de seguridad personalizadas.
                            </p>

                            <h6>¿Qué datos se envían?</h6>
                            <p class="small text-muted">
                                Solo se envían estadísticas agregadas y muestras de conexiones denegadas.
                                No se envían direcciones IP internas ni datos sensibles.
                            </p>

                            <h6>Alternativa: Variable de Entorno</h6>
                            <p class="small text-muted">
                                También puedes configurar la variable <code>GEMINI_API_KEY</code> en el servidor
                                para aplicar a todas las empresas.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importLogsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="import-form" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Importar Logs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Archivo de Logs (CSV)</label>
                        <input type="file" name="file" class="form-control" required accept=".log,.csv,.txt">
                        <div class="form-text">
                            Formato FortiAnalyzer CSV. El equipo se detecta automáticamente del serial (devid) en los
                            logs.
                        </div>
                    </div>
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Auto-detección:</strong> El sistema buscará el serial del dispositivo dentro del archivo
                        de logs y lo asociará con el equipo correspondiente en tu inventario.
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="analyze_ai" id="analyzeAiCheck" checked>
                        <label class="form-check-label" for="analyzeAiCheck">
                            Ejecutar análisis de Seguridad AI
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btn-import-submit">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status"
                            aria-hidden="true"></span>
                        Importar y Analizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Policy Analysis Modal -->
<style>
    /* Fix text wrapping in modal */
    #policyAnalysisModal .badge {
        white-space: normal;
        word-break: break-word;
        text-align: left;
        display: inline-block;
        max-width: 100%;
    }

    #policyAnalysisModal td {
        word-break: break-word;
        max-width: 300px;
    }

    #policyAnalysisModal .alert {
        word-break: break-word;
    }
</style>
<div class="modal fade" id="policyAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Análisis Detallado de Política</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="policyAnalysisContent">
                <!-- Loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a href="{{ url_for('policy.list_policies') }}" class="btn btn-primary" target="_blank"
                    id="btn-go-to-policy">
                    <i class="bi bi-box-arrow-up-right me-1"></i>Ir a Policy Explorer
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Detalles Log API</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-dark text-light p-0">
                <pre class="m-0 p-3" id="logDetailsContent"
                    style="white-space: pre-wrap; font-size: 0.85rem; font-family: monospace;"></pre>
            </div>
            <div class="modal-footer bg-dark border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api/v1';
    const API_TOKEN = '{{ api_token }}'; // Injected by Backend
    let currentPage = 1;
    let currentPerPage = 32;

    // Helper for API Calls
    async function apiCall(endpoint, method = 'GET', body = null) {
        const headers = {
            'Authorization': `Bearer ${API_TOKEN}`,
            'Accept': 'application/json'
        };
        // Do not set Content-Type if Body is FormData (it sets it automatically with boundary)
        if (body && !(body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
        }

        const config = { method, headers };
        if (body) config.body = body;

        const response = await fetch(`${API_BASE}${endpoint}`, config);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Error desconocido');
        }
        return data;
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadLogs();
        loadStats();  // Load statistics for cards
        loadRecommendations();
        // loadImportHistory(); // TODO: Implement import history

        // Remove old filter-form listener, use global inputs onchange/onclick
        // Listeners for global inputs are added inline or can be added here

        document.getElementById('global-filter-form').addEventListener('submit', (e) => {
            e.preventDefault();
            currentPage = 1;
            loadLogs();
        });

        document.getElementById('import-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-import-submit');
            const spinner = btn.querySelector('.spinner-border');

            btn.disabled = true;
            spinner.classList.remove('d-none');

            const formData = new FormData(e.target);

            try {
                const result = await apiCall('/analyzer/import', 'POST', formData);
                alert('Logs importados correctamente. Sesión: ' + result.import_session_id + '\nLogs: ' + result.log_count);
                location.reload();
            } catch (error) {
                console.error(error);
                alert('Error al importar: ' + error.message);
            } finally {
                btn.disabled = false;
                spinner.classList.add('d-none');
                const modal = bootstrap.Modal.getInstance(document.getElementById('importLogsModal'));
                modal.hide();
            }
        });
    });

    async function loadLogs() {
        const tbody = document.getElementById('logs-table-body');

        try {
            // Get Filters GLOBALLY
            const deviceId = document.getElementById('global-device-select').value;
            const search = document.getElementById('global-search-input').value;

            const url = `/analyzer?page=${currentPage}&per_page=${currentPerPage}&q=${encodeURIComponent(search)}&device_id=${deviceId}`;
            const data = await apiCall(url);

            tbody.innerHTML = '';

            if (data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-muted">No se encontraron logs</td></tr>';
                // Do not return early, proceed to update pagination (which will set it to 0)
            } else {
                data.data.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="small">${log.timestamp ? new Date(log.timestamp).toLocaleString() : '-'}</td>
                        <td><span class="badge bg-${getLevelBadge(log.level)}">${log.level || 'N/A'}</span></td>
                        <td class="small">${log.vdom || 'root'}</td>
                        <td class="small">${log.log_type || '-'}</td>
                        <td>${log.src_ip || '-'}</td>
                        <td>${log.dst_ip || '-'}</td>
                        <td>${log.service || '-'}</td>
                        <td><span class="badge bg-${log.action === 'accept' ? 'success' : (log.action === 'deny' ? 'danger' : 'secondary')}">${log.action || '-'}</span></td>
                        <td class="small">${log.app || '-'}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info border-0" onclick="viewLogDetails('${log.id}')" title="Ver Detalles Raw">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            updatePagination(data.pagination);

            // Check Stats (Optional update)
            // document.getElementById('stat-total-logs').innerText = data.meta.total;

        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    function getLevelBadge(level) {
        if (!level) return 'secondary';
        level = level.toLowerCase();
        if (level === 'critical' || level === 'alert') return 'danger';
        if (level === 'error') return 'warning text-dark';
        if (level === 'warning') return 'warning text-dark';
        if (level === 'notice') return 'info text-dark';
        return 'secondary';
    }

    function changePerPage(val) {
        currentPerPage = parseInt(val);
        document.querySelectorAll('.per-page-select').forEach(el => el.value = val);
        currentPage = 1;
        loadLogs();
    }

    async function viewLogDetails(logId) {
        const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
        const content = document.getElementById('logDetailsContent');
        content.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-light"></div></div>';
        modal.show();

        try {
            const data = await apiCall(`/analyzer/${logId}`);
            if (data.success) {
                const raw = data.data.raw_data || data.data;
                content.textContent = JSON.stringify(raw, null, 2);
            } else {
                content.innerText = 'No details found.';
            }
        } catch (e) {
            content.innerText = 'Error: ' + e.message;
        }
    }

    function updatePagination(pagination) {
        if (!pagination) return;

        ['top', 'bottom'].forEach(pos => {
            const container = document.getElementById(`pagination-controls-${pos}`);
            const info = document.getElementById(`pagination-info-${pos}`);
            if (!container || !info) return;

            // If total is 0, show simplified message
            if (pagination.total === 0) {
                info.innerText = 'Mostrando 0-0 de 0';
                container.innerHTML = '';
                return;
            }

            const startItem = ((pagination.page - 1) * pagination.per_page) + 1;
            const endItem = Math.min(pagination.page * pagination.per_page, pagination.total);
            info.innerText = `Mostrando ${pagination.total > 0 ? startItem : 0}-${endItem} de ${pagination.total}`;

            container.innerHTML = '';

            const hasPrev = pagination.page > 1;
            const hasNext = pagination.page < pagination.pages;

            // Prev
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${!hasPrev ? 'disabled' : ''}`;
            prevLi.innerHTML = `<button class="page-link">Anterior</button>`;
            prevLi.onclick = () => { if (hasPrev) { currentPage--; loadLogs(); } };
            container.appendChild(prevLi);

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${!hasNext ? 'disabled' : ''}`;
            nextLi.innerHTML = `<button class="page-link">Siguiente</button>`;
            nextLi.onclick = () => { if (hasNext) { currentPage++; loadLogs(); } };
            container.appendChild(nextLi);
        });
    }

    async function loadStats() {
        try {
            // Get Filters GLOBALLY for consistent stats
            const deviceId = document.getElementById('global-device-select').value;
            let url = '/analyzer/stats';
            if (deviceId) {
                url += `?device_id=${deviceId}`;
            }

            const data = await apiCall(url);
            if (data.success && data.data) {
                const stats = data.data;

                // Total logs
                document.getElementById('stat-total-logs').textContent =
                    stats.total_logs?.toLocaleString() || '0';

                // Threats (deny, block, dropped actions)
                const threats = (stats.by_action?.deny || 0) +
                    (stats.by_action?.blocked || 0) +
                    (stats.by_action?.dropped || 0);
                document.getElementById('stat-threats').textContent =
                    threats.toLocaleString();

                // Accepted
                const accepted = stats.by_action?.accept || 0;
                document.getElementById('stat-accepted').textContent =
                    accepted.toLocaleString();

                // Populate Breakdown
                const breakdownContainer = document.getElementById('actions-breakdown');
                if (breakdownContainer && stats.by_action) {
                    breakdownContainer.innerHTML = '';
                    // Sort by count desc
                    const entries = Object.entries(stats.by_action).sort((a, b) => b[1] - a[1]);

                    entries.forEach(([action, count]) => {
                        let color = 'secondary';
                        if (['accept'].includes(action)) color = 'success';
                        else if (['deny', 'blocked', 'dropped'].includes(action)) color = 'danger';
                        else if (['close', 'timeout'].includes(action)) color = 'dark';
                        else if (['client-rst', 'server-rst'].includes(action)) color = 'warning text-dark';

                        const el = document.createElement('div');
                        el.className = `badge bg-light text-dark border d-flex align-items-center px-2 py-1`;
                        el.innerHTML = `
                            <span class="badge bg-${color} rounded-circle me-2 p-1" style="width:8px; height:8px;"></span>
                            <span class="text-capitalize me-2">${action}</span>
                            <strong>${count.toLocaleString()}</strong>
                        `;
                        breakdownContainer.appendChild(el);
                    });
                }
            }

            // Also load recommendation count
            try {
                const recData = await apiCall('/analyzer/recommendations?per_page=1');
                if (recData.success && recData.pagination) {
                    document.getElementById('stat-recommendations').textContent =
                        (recData.pagination.total || 0).toLocaleString();
                } else if (recData.success && recData.data) {
                    document.getElementById('stat-recommendations').textContent =
                        recData.data.length.toString();
                }
            } catch (e) {
                document.getElementById('stat-recommendations').textContent = '0';
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function runAIAnalysis() {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analizando...';

        // Collect AI parameters including v1.3.0 segmentation
        const params = {
            analyze_denied: document.getElementById('ai-denied').checked,
            analyze_high_volume: document.getElementById('ai-high-volume').checked,
            analyze_geo: document.getElementById('ai-geo').checked,
            optimize_policies: document.getElementById('ai-policy-opt').checked,
            suggest_new_policies: document.getElementById('ai-new-policies').checked,
            threshold: document.getElementById('ai-threshold').value,
            // v1.3.0 - Segmentation filters
            device_id: document.getElementById('ai-device').value || null,
            vdom: document.getElementById('ai-vdom').value || null,
            src_intf: document.getElementById('ai-src-intf').value || null,
            dst_intf: document.getElementById('ai-dst-intf').value || null
        };

        try {
            const result = await apiCall('/analyzer/analyze', 'POST', JSON.stringify(params));
            const recCount = result.recommendations_count || 0;
            const newPolicies = result.new_policies_count || 0;
            alert(`Análisis completado. Se generaron ${recCount} recomendaciones${newPolicies > 0 ? ` y ${newPolicies} nuevas políticas sugeridas` : ''}.`);
            loadRecommendations();
            loadStats();
        } catch (error) {
            alert('Error en análisis AI: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // v1.3.0 - Dynamic dropdown loaders for segmentation
    function loadDevicesForSite() {
        const siteId = document.getElementById('ai-site').value;
        const deviceSelect = document.getElementById('ai-device');
        const options = deviceSelect.querySelectorAll('option');

        let firstVisible = '';

        options.forEach(opt => {
            if (!opt.value) return; // Skip "All" option

            const deviceSiteId = opt.getAttribute('data-site-id');
            if (!siteId || deviceSiteId === siteId) {
                opt.style.display = '';
                if (!firstVisible) firstVisible = opt.value;
            } else {
                opt.style.display = 'none';
            }
        });

        // Reset selection to "All" or first valid option if current is hidden
        const currentOpt = deviceSelect.options[deviceSelect.selectedIndex];
        if (currentOpt.style.display === 'none') {
            deviceSelect.value = '';
        }

        // Trigger downstream update
        loadVdomsForDevice();
    }

    // v1.3.0 - Dynamic dropdown loaders for segmentation
    async function loadVdomsForDevice() {
        const deviceId = document.getElementById('ai-device').value;
        const vdomSelect = document.getElementById('ai-vdom');
        const srcIntfSelect = document.getElementById('ai-src-intf');
        const dstIntfSelect = document.getElementById('ai-dst-intf');

        // Reset dependent dropdowns
        vdomSelect.innerHTML = '<option value="">Todos los VDOMs</option>';
        srcIntfSelect.innerHTML = '<option value="">Src Interface</option>';
        dstIntfSelect.innerHTML = '<option value="">Dst Interface</option>';

        if (!deviceId) return;

        try {
            // Load VDOMs from logs (distinct values)
            const data = await apiCall(`/analyzer/stats?device_id=${deviceId}`);
            if (data.success && data.data.by_vdom) {
                Object.keys(data.data.by_vdom).forEach(vdom => {
                    const opt = document.createElement('option');
                    opt.value = vdom;
                    opt.textContent = vdom;
                    vdomSelect.appendChild(opt);
                });
            }
            // Also load interfaces
            loadInterfacesForDevice(deviceId);
        } catch (e) {
            console.warn('Could not load VDOMs:', e);
        }
    }

    async function loadInterfacesForDevice(deviceId) {
        const srcIntfSelect = document.getElementById('ai-src-intf');
        const dstIntfSelect = document.getElementById('ai-dst-intf');

        try {
            // Get unique interfaces from logs
            const data = await apiCall(`/analyzer?device_id=${deviceId}&per_page=1`);
            if (data.success) {
                // Use stats to get interface breakdown
                const statsData = await apiCall(`/analyzer/stats?device_id=${deviceId}`);
                if (statsData.success && statsData.data.by_src_intf) {
                    Object.keys(statsData.data.by_src_intf).forEach(intf => {
                        const opt1 = document.createElement('option');
                        opt1.value = intf;
                        opt1.textContent = intf;
                        srcIntfSelect.appendChild(opt1);

                        const opt2 = document.createElement('option');
                        opt2.value = intf;
                        opt2.textContent = intf;
                        dstIntfSelect.appendChild(opt2);
                    });
                }
            }
        } catch (e) {
            console.warn('Could not load interfaces:', e);
        }
    }

    function loadInterfacesForVdom() {
        // Could filter interfaces by VDOM if needed
        // For now, keep all interfaces loaded
    }

    let recPage = 1;
    let recPerPage = 32;

    function changeRecPerPage(val) {
        recPerPage = parseInt(val);
        document.querySelectorAll('.rec-per-page-select').forEach(el => el.value = val);
        recPage = 1;
        loadRecommendations();
    }

    async function exportRecommendations(mode, format = 'csv') {
        let selectedIds = [];
        if (mode === 'selected') {
            const chks = document.querySelectorAll('.rec-chk:checked');
            if (chks.length === 0) {
                alert('Por favor selecciona al menos una recomendación para exportar.');
                return;
            }
            selectedIds = Array.from(chks).map(cb => cb.value);
        }

        // Find the clicking element safely
        if (event && event.target) {
            // Optional: visual feedback
        }

        try {
            const deviceId = document.querySelector('select[name="device_id"]').value;

            const payload = {
                ids: selectedIds,
                format: format,
                filters: {
                    all: mode === 'all',
                    device_id: deviceId
                }
            };

            const response = await fetch(`${API_BASE}/analyzer/recommendations/export`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Export failed');

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `recommendations_${mode}_${new Date().toISOString().slice(0, 10)}.${format}`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (error) {
            alert('Error exportando: ' + error.message);
        }
    }

    let currentAuditTab = 'static'; // Default

    async function loadStaticAudit() {
        // Get device ID from Global Filter
        let deviceId = document.getElementById('global-device-select').value;
        // Allow empty device ID for "All Devices" scan

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analizando...';

        try {
            await apiCall('/analyzer/audit/static', 'POST', JSON.stringify({ device_id: deviceId || 'all' }));
            loadRecommendations('static');
            // Reload stats to reflect new counts
            loadStats();
        } catch (e) {
            alert('Error en auditoría estática: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function runDynamicAudit() {
        let deviceId = document.getElementById('global-device-select').value;
        // Allow empty device ID for "All Devices" scan

        const btn = event.currentTarget;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analizando...';

        try {
            await apiCall('/analyzer/audit/dynamic', 'POST', JSON.stringify({ device_id: deviceId || 'all', days_back: 30 }));
            loadRecommendations('dynamic');
            // Reload stats to reflect new counts
            loadStats();
        } catch (e) {
            alert('Error en auditoría dinámica: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function loadRecommendations(type) {
        if (type) currentAuditTab = type;

        let containerId = '';
        let categories = [];

        if (currentAuditTab === 'static') {
            containerId = 'static-audit-container';
            categories = ['optimize_policy', 'policy', 'security'];
        } else if (currentAuditTab === 'dynamic') {
            containerId = 'dynamic-audit-container';
            categories = ['optimization', 'traffic', 'security', 'ai_security', 'ai_new_policy', 'vdom_audit'];
        } else {
            return; // Unknown tab
        }

        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>Cargando resultados...</p></div>';

        try {
            // Get Device Filter
            const deviceId = document.getElementById('global-device-select').value;

            let url = `/analyzer/recommendations?page=${recPage}&per_page=${recPerPage}`;
            if (deviceId) url += `&device_id=${deviceId}`;
            if (categories.length > 0) url += `&category=${categories.join(',')}`;

            const data = await apiCall(url);
            container.innerHTML = '';

            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-check-circle fs-1 mb-3 d-block text-success"></i><p>No se encontraron problemas de seguridad.</p></div>';
                updateRecPagination(null);
                return;
            }

            data.data.forEach(rec => {
                // Determine styling based on category
                const isNewPolicy = rec.category === 'ai_new_policy' || rec.category === 'new_policy';
                const isCritical = rec.severity === 'critical' || rec.severity === 'high';

                let borderColor = 'border-info';
                let iconClass = 'bi-info-circle-fill text-info';

                if (isCritical) {
                    borderColor = 'border-danger';
                    iconClass = 'bi-exclamation-octagon-fill text-danger';
                } else if (isNewPolicy) {
                    borderColor = 'border-success';
                    iconClass = 'bi-plus-circle-fill text-success';
                } else if (rec.severity === 'medium') {
                    borderColor = 'border-warning';
                    iconClass = 'bi-exclamation-triangle-fill text-warning';
                }

                const div = document.createElement('div');
                div.className = `alert alert-light border-start ${borderColor} border-4 shadow-sm mb-3`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-center">
                            <div class="form-check me-2">
                                <input class="form-check-input rec-chk" type="checkbox" value="${rec.id}">
                            </div>
                            <h6 class="alert-heading fw-bold mb-1">
                                <i class="bi ${iconClass} me-2"></i>${rec.title || 'Recomendación'}
                            </h6>
                        </div>
                        <span class="badge bg-${rec.severity === 'high' || rec.severity === 'critical' ? 'danger' : (rec.severity === 'medium' ? 'warning' : 'info')} text-uppercase">${rec.severity}</span>
                    </div>
                    <p class="mb-2 text-muted small">${rec.created_at ? new Date(rec.created_at).toLocaleString() : ''} | Cat: ${rec.category}</p>
                    <p class="mb-2">${rec.description || ''}</p>
                    ${rec.affected_count ? `<p class="small mb-2"><strong>${rec.affected_count}</strong> eventos relacionados</p>` : ''}
                    
                    ${(rec.related_policy_id || rec.related_policy_id === 0) ? `
                        <div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 border rounded">
                            <p class="small mb-0"><i class="bi bi-shield me-1"></i>Política: <code>${rec.related_policy_id}</code></p>
                            <button class="btn btn-sm btn-outline-dark py-0" onclick="viewPolicyAnalysis('${rec.related_policy_id}', '${rec.device_id}', this)" data-rec='${JSON.stringify(rec).replace(/'/g, "&#39;")}'>
                                <i class="bi bi-search me-1"></i>Ver Detalle
                            </button>
                        </div>
                    ` : ''}
                    
                    <hr class="my-2">
                    <div class="small" style="white-space: pre-wrap; word-break: break-word;"><strong>Recomendación:</strong> ${rec.recommendation || 'N/A'}</div>
                    
                    ${rec.cli_remediation ? `
                         <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#cli-${rec.id.replace(/\W/g, '')}">
                                <i class="bi bi-terminal me-1"></i>Ver CLI
                            </button>
                            <div class="collapse mt-2 text-start" id="cli-${rec.id.replace(/\W/g, '')}">
                                <div class="bg-dark p-2 rounded position-relative">
                                    <pre class="text-success small mb-0 font-monospace">${rec.cli_remediation}</pre>
                                    <button class="btn btn-xs btn-outline-secondary position-absolute top-0 end-0 m-1 py-0" onclick="navigator.clipboard.writeText(this.previousElementSibling.innerText)">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                         </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });

            updateRecPagination(data.pagination);

        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">Error cargando recomendaciones: ${error.message}</div>`;
        }
    }

    function updateRecPagination(pagination) {
        const uls = document.querySelectorAll('.rec-pagination-controls');

        // Calculate display info
        const totalCount = pagination ? pagination.total : 0;
        const start = pagination && totalCount > 0 ? ((pagination.page - 1) * pagination.per_page) + 1 : 0;
        const end = pagination ? Math.min(pagination.page * pagination.per_page, totalCount) : 0;
        const infoText = `Mostrando ${start}-${end} de ${totalCount}`;

        // Update info displays for both tabs (top and bottom)
        const infoIds = currentAuditTab === 'static'
            ? ['static-pagination-info-top', 'static-pagination-info-bottom']
            : ['dynamic-pagination-info-top', 'dynamic-pagination-info-bottom'];

        infoIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = infoText;
        });

        uls.forEach(ul => {
            ul.innerHTML = '';
            if (!pagination || pagination.pages <= 1) return;

            // Previous
            ul.innerHTML += `
                <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="recPage--; loadRecommendations()">Anterior</button>
                </li>
            `;

            // Simple Page info (Page X of Y)
            const start = ((pagination.page - 1) * pagination.per_page) + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            ul.innerHTML += `
                <li class="page-item disabled">
                    <span class="page-link text-muted small">Mostrando ${pagination.total > 0 ? start : 0}-${end} de ${pagination.total}</span>
                </li>
            `;

            // Next
            ul.innerHTML += `
                <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
                    <button class="page-link" onclick="recPage++; loadRecommendations()">Siguiente</button>
                </li>
            `;
        });
    }

    async function viewPolicyAnalysis(policyId, deviceId, btn) {
        const rec = JSON.parse(btn.getAttribute('data-rec'));
        const modal = new bootstrap.Modal(document.getElementById('policyAnalysisModal'));
        const content = document.getElementById('policyAnalysisContent');

        // Update Go To Policy Button Link (Deep Linking)
        const linkBtn = document.getElementById('btn-go-to-policy');
        if (linkBtn && deviceId) {
            // Pass filter parameters to Policy Explorer
            let url = `/policies?device_id=${deviceId}&q=${policyId}`;
            if (rec.related_vdom) url += `&vdom=${encodeURIComponent(rec.related_vdom)}`;
            linkBtn.href = url;
        }

        content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>Cargando detalles de la política...</p></div>';
        modal.show();

        try {
            // Handle Implicit Deny (Policy 0)
            if (policyId === '0' || policyId === 0) {
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="fw-bold text-danger mb-3"><i class="bi bi-shield-x me-2"></i>Política Implícita (Implicit Deny)</h6>
                            <div class="alert alert-secondary">
                                <p class="small mb-2"><strong>ID:</strong> 0</p>
                                <p class="small mb-2">Esta es la regla por defecto de FortiGate que deniega todo el tráfico que no coincide con ninguna otra política.</p>
                                <hr>
                                <p class="small mb-0"><strong>Acción:</strong> <span class="badge bg-danger">DENY</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-warning mb-3"><i class="bi bi-stars me-2"></i>Análisis AI y Sugerencia</h6>
                            <div class="alert alert-light border border-warning">
                                <h6 class="alert-heading small fw-bold">${rec.title}</h6>
                                <p class="small mb-2">${rec.description}</p>
                                <hr>
                                <div class="bg-white p-2 rounded border">
                                    <strong class="d-block small text-muted mb-1">Acción Recomendada:</strong>
                                    <code class="text-dark" style="white-space: pre-wrap; word-break: break-word; display: block;">${rec.recommendation}</code>
                                </div>
                                ${rec.cli_remediation ? `
                                    <div class="mt-2 bg-dark p-2 rounded border border-secondary">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <strong class="small text-light">CLI Remediation:</strong>
                                            <button class="btn btn-xs btn-outline-secondary py-0" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)"><i class="bi bi-clipboard"></i></button>
                                        </div>
                                        <pre class="mb-0 text-success small" style="white-space: pre-wrap; font-family: monospace;">${rec.cli_remediation}</pre>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="mt-3">
                                <p class="small text-muted"><i class="bi bi-info-circle me-1"></i>Debe crear una nueva política explícita para permitir este tráfico si es legítimo.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Fetch policy details for explicit policies
            if (!deviceId || deviceId === 'None' || deviceId === 'undefined') {
                // Try to get from filter
                deviceId = document.querySelector('select[name="device_id"]').value;
            }

            if (!deviceId) {
                content.innerHTML = '<div class="alert alert-danger">Error: No se pudo identificar el dispositivo asociado a esta política.</div>';
                return;
            }

            // Use direct fetch to handle non-JSON errors better
            const response = await fetch(`/api/v1/policies?device_id=${deviceId}&policy_id=${policyId}`, {
                headers: {
                    'Authorization': 'Bearer ' + (localStorage.getItem('token') || ''),
                    'X-Company-ID': localStorage.getItem('company_id') || ''
                }
            });

            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Server Error (${response.status}): ${text.substring(0, 200)}...`);
            }

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                const policy = data.data[0];

                // Helper to format lists
                const formatList = (items) => Array.isArray(items) && items.length > 0 ? items.map(i => `<span class="badge bg-light text-dark border me-1">${i}</span>`).join('') : '<span class="text-muted">ALL</span>';

                // Extract details from raw_data if available for richer context
                const raw = policy.raw_data || {};
                const srcAddr = raw['Source Address'] || raw['Source'] || [policy.src_addr];
                const dstAddr = raw['Destination Address'] || raw['Destination'] || [policy.dst_addr];
                const services = raw['Service'] || [policy.service];
                const schedule = raw['Schedule'] || 'always';
                const logTraffic = raw['Log Traffic'] || 'all';

                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-7 border-end">
                            <h6 class="fw-bold text-primary mb-3">
                                <i class="bi bi-sliders me-2"></i>Configuración de Política ID: <a href="/policies?device_id=${deviceId}&q=${policy.policy_id}&vdom=${encodeURIComponent(policy.vdom || '')}" target="_blank" class="text-decoration-none">${policy.policy_id} <i class="bi bi-box-arrow-up-right small ms-1 text-muted" style="font-size: 0.8em;"></i></a>
                            </h6>
                            
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body p-3">
                                    <h6 class="card-title small fw-bold text-uppercase text-muted mb-2">General</h6>
                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <small class="d-block text-muted">Nombre</small>
                                            <strong>${policy.name || '-'}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="d-block text-muted">Acción</small>
                                            <span class="badge bg-${policy.action === 'ACCEPT' ? 'success' : 'danger'}">${policy.action}</span>
                                        </div>
                                    </div>
                                    
                                    <h6 class="card-title small fw-bold text-uppercase text-muted mt-3 mb-2">Reglas de Tráfico</h6>
                                    <table class="table table-sm table-borderless small mb-0">
                                        <tr>
                                            <td style="width: 100px" class="text-muted">Origen:</td>
                                            <td>${formatList(srcAddr)} <span class="text-muted ms-1">(${policy.src_intf})</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Destino:</td>
                                            <td>${formatList(dstAddr)} <span class="text-muted ms-1">(${policy.dst_intf})</span></td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Servicios:</td>
                                            <td>${formatList(services)}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Horario:</td>
                                            <td>${schedule}</td>
                                        </tr>
                                         <tr>
                                            <td class="text-muted">NAT:</td>
                                            <td>${policy.nat === 'Enabled' ? '<i class="bi bi-check-circle-fill text-success"></i> Activado' : '<span class="text-muted">Desactivado</span>'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <h6 class="fw-bold text-warning mb-3"><i class="bi bi-robot me-2"></i>Análisis de Seguridad AI</h6>
                            <div class="alert alert-light border border-warning shadow-sm">
                                <h6 class="alert-heading small fw-bold mb-2">${rec.title}</h6>
                                <p class="small mb-3">${rec.description}</p>
                                
                                <div class="bg-white p-3 rounded border">
                                    <h6 class="small fw-bold text-dark mb-2"><i class="bi bi-wrench-adjustable me-1"></i>Acción Recomendada</h6>
                                    <p class="small text-muted mb-2" style="white-space: pre-wrap; word-break: break-word;">${rec.recommendation}</p>
                                    
                                    ${rec.cli_remediation ? `
                                        <hr class="my-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <strong class="small text-secondary">Comando CLI Sugerido:</strong>
                                            <button class="btn btn-xs btn-link text-decoration-none p-0" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText)">
                                                <i class="bi bi-clipboard"></i> Copiar
                                            </button>
                                        </div>
                                        <div class="bg-dark rounded p-2 position-relative">
                                            <pre class="mb-0 text-success small text-wrap font-monospace" style="font-size: 0.75rem;">${rec.cli_remediation}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = `<div class="alert alert-warning">No se encontró la política ID ${policyId} en la base de datos (puede haber sido borrada o no sincronizada).</div>`;
            }
        } catch (error) {
            content.innerHTML = `<div class="alert alert-danger">Error obteniendo detalles: ${error.message}</div>`;
        }
    }

    function refreshRecommendations() {
        loadRecommendations();
    }

    // ============================================
    // Configuration Tab Functions
    // ============================================

    function toggleApiKeyVisibility() {
        const input = document.getElementById('gemini-api-key');
        const icon = document.getElementById('eye-icon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    async function loadConfigStatus() {
        const statusBadge = document.getElementById('api-key-status');
        try {
            const data = await apiCall('/analyzer/config');
            if (data.has_api_key) {
                statusBadge.className = 'badge bg-success me-2';
                statusBadge.textContent = 'Configurado';
            } else {
                statusBadge.className = 'badge bg-warning me-2';
                statusBadge.textContent = 'No configurado';
            }
        } catch (error) {
            statusBadge.className = 'badge bg-danger me-2';
            statusBadge.textContent = 'Error';
        }
    }

    document.getElementById('gemini-config-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-save-config');
        const apiKey = document.getElementById('gemini-api-key').value;

        if (!apiKey) {
            alert('Por favor ingresa una API Key');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

        try {
            const response = await apiCall('/analyzer/config', 'POST', JSON.stringify({ gemini_api_key: apiKey }));
            alert('Configuración guardada correctamente');
            document.getElementById('gemini-api-key').value = '';
            loadConfigStatus();
        } catch (error) {
            alert('Error al guardar: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Guardar Configuración';
        }
    });

    // Load config status when tab is shown
    document.getElementById('config-tab')?.addEventListener('shown.bs.tab', () => {
        loadConfigStatus();
    });

    // Deletion Functions
    async function confirmDeleteLogs() {
        if (!confirm('ADVERTENCIA: ¿Está seguro de eliminar TODOS los logs y estadísticas?\n\nEsta acción no se puede deshacer.')) return;

        try {
            const deviceId = document.querySelector('select[name="device_id"]').value;
            let url = '/analyzer';
            if (deviceId) url += `?device_id=${deviceId}`;

            const btn = document.getElementById('actionsDropdown');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...';

            const data = await apiCall(url, 'DELETE');
            if (data.success) {
                alert(`Se eliminaron ${data.deleted_count} registros.`);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Desconocido'));
            }
        } catch (error) {
            alert('Error al eliminar logs: ' + error.message);
        } finally {
            const btn = document.getElementById('actionsDropdown');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    }

    async function confirmDeleteRecommendations() {
        if (!confirm('¿Está seguro de eliminar todas las recomendaciones de seguridad?')) return;

        try {
            const deviceId = document.querySelector('select[name="device_id"]').value;
            let url = '/analyzer/recommendations';
            if (deviceId) url += `?device_id=${deviceId}`;

            const data = await apiCall(url, 'DELETE');
            if (data.success) {
                alert(`Se eliminaron ${data.deleted_count} recomendaciones.`);
                refreshRecommendations();
            } else {
                alert('Error: ' + (data.error || 'Desconocido'));
            }
        } catch (error) {
            alert('Error al eliminar recomendaciones: ' + error.message);
        }
    }

    // Topology Globals
    let topologyNetwork = null;
    let topologyNodes = null;
    let topologyEdges = null;

    async function loadTopology() {
        const siteId = document.getElementById('topology-site-filter').value;
        const mode = document.getElementById('topology-mode').value;
        const container = document.getElementById('topology-network');

        container.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center"><div class="spinner-border text-primary"></div></div>';

        try {
            const data = await apiCall(`/analyzer/topology?site_id=${siteId || ''}&mode=${mode}`);

            // Debug Output
            const debugPre = document.getElementById('topology-json-output');
            if (debugPre) {
                debugPre.textContent = JSON.stringify(data, null, 2);
            }

            if (!data.success || !data.nodes || data.nodes.length === 0) {
                container.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center text-muted">No data available for topology</div>';
                return;
            }

            // TEXT VIEW HANDLER
            if (topologyViewMode === 'text') {
                renderTopologyText(container, data.nodes, data.edges);
                return;
            }

            // Clean container for graphic
            container.innerHTML = '';

            // If loaded saved data, perhaps auto-switch dropdown to 'saved' if we asked for dynamic but got saved?
            // API logic: if dynamic, returns generated. If saved, returns stored.
            // If response has is_saved=true, user might want to know.
            if (data.is_saved && mode === 'saved') {
                // Good
            }

            // Create a network
            topologyNodes = new vis.DataSet(data.nodes);
            topologyEdges = new vis.DataSet(data.edges);

            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: { size: 14 }
                },
                edges: {
                    font: { size: 12, align: 'middle' },
                    color: { color: '#848484', highlight: '#848484', hover: '#848484' },
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                    smooth: { type: 'continuous' }
                },
                physics: {
                    stabilization: false,
                    barnesHut: { gravitationalConstant: -2000, springConstant: 0.04 }
                },
                layout: {
                    hierarchical: {
                        enabled: mode === 'dynamic', // Only use hierarchy for dynamic initial layout
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 150,
                        levelSeparation: 150
                    }
                },
                interaction: { hover: true }
            };

            topologyNetwork = new vis.Network(container, { nodes: topologyNodes, edges: topologyEdges }, options);

            // Center graph after stabilization
            topologyNetwork.once("stabilizationIterationsDone", function () {
                topologyNetwork.fit({
                    animation: { duration: 1000, easingFunction: 'easeInOutQuad' }
                });
            });

        } catch (error) {
            console.error('Topology error:', error);
            container.innerHTML = `<div class="alert alert-danger m-3">Error loading topology: ${error.message}</div>`;
        }
    }

    async function saveTopology() {
        const siteId = document.getElementById('topology-site-filter').value;
        if (!siteId) {
            alert("Seleccione un sitio para guardar la topología.");
            return;
        }
        if (!topologyNetwork) return;

        if (!confirm("¿Desea guardar el diseño actual para este sitio?")) return;

        try {
            // Get positions
            const positions = topologyNetwork.getPositions();

            // Merge positions into nodes array
            const nodes = topologyNodes.get().map(n => {
                if (positions[n.id]) {
                    n.x = positions[n.id].x;
                    n.y = positions[n.id].y;
                }
                return n;
            });

            const edges = topologyEdges.get();

            const payload = {
                site_id: siteId,
                topology: {
                    nodes: nodes,
                    edges: edges
                }
            };

            const response = await apiCall('/analyzer/topology', 'POST', JSON.stringify(payload));
            if (response.success) {
                alert("Topología guardada correctamente.");
            } else {
                alert("Error: " + response.error);
            }

        } catch (e) {
            alert("Error al guardar: " + e.message);
        }
    }


    // Toggle View Mode
    let topologyViewMode = 'graphic'; // graphic vs text

    function toggleTopologyView() {
        topologyViewMode = topologyViewMode === 'graphic' ? 'text' : 'graphic';
        loadTopology(); // Reload to render in new mode
    }

    function renderTopologyText(container, nodes, edges) {
        // Build hierarchy: Site -> Device -> VDOM -> Interface
        let html = '<div class="p-4" style="overflow-y: auto; max-height: 600px;">';

        let sites = nodes.filter(n => n.group === 'site');

        if (sites.length === 0 && nodes.length > 0) {
            // If no sites explicitly (fallback), try to group everything else
            sites = [{ id: 'unknown', label: 'Site Desconocido', group: 'site' }];
        }

        sites.forEach(site => {
            html += `<h5 class="text-danger border-bottom pb-2"><i class="bi bi-circle-fill me-2"></i>${site.label}</h5>`;

            // Devices for this site
            // In graph, edges connected site->device. 
            // We can look for edges from site.id or look for nodes that belong (if we had parent prop).
            // Using edges is safer given the vis.js structure.
            let deviceEdges = edges.filter(e => e.from === site.id);
            let devices = nodes.filter(n => n.group === 'device' && deviceEdges.some(e => e.to === n.id));

            if (site.id === 'unknown') {
                devices = nodes.filter(n => n.group === 'device');
            }

            if (devices.length === 0) {
                html += '<p class="text-muted ms-4">No devices found.</p>';
            }

            html += '<ul class="list-group ms-3 mb-3 border-start border-3 border-primary">';
            devices.forEach(dev => {
                html += `<li class="list-group-item border-0 bg-light mb-1">
                            <i class="bi bi-hdd-network-fill text-primary me-2"></i><strong>${dev.label}</strong>
                            <ul class="list-group mt-2 ms-3 border-start border-3 border-success">`;

                let vdomEdges = edges.filter(e => e.from === dev.id);
                let vdoms = nodes.filter(n => n.group === 'vdom' && vdomEdges.some(e => e.to === n.id));

                vdoms.forEach(vdom => {
                    html += `<li class="list-group-item border-0 pt-1 pb-1">
                                <i class="bi bi-hexagon-fill text-success me-2"></i>${vdom.label}
                                <ul class="list-group mt-1 ms-3 border-start border-2">`;

                    let intfEdges = edges.filter(e => e.from === vdom.id);
                    let intfs = nodes.filter(n => n.group === 'interface' && intfEdges.some(e => e.to === n.id));

                    intfs.forEach(intf => {
                        // Parse label for IP
                        let parts = intf.label.split('\n');
                        let name = parts[0];
                        let ip = parts.length > 1 ? parts[1] : '';
                        let badgeClass = intf.color === '#dc3545' ? 'danger' : (intf.color === '#0dcaf0' ? 'info' : 'secondary');

                        html += `<li class="list-group-item border-0 py-0 small text-muted">
                                    <i class="bi bi-link me-1"></i> ${name} 
                                    ${ip ? `<span class="badge bg-${badgeClass} ms-2">${ip}</span>` : ''}
                                  </li>`;
                    });

                    if (intfs.length === 0) html += '<li class="list-group-item border-0 text-muted small">No interfaces</li>';

                    html += `</ul></li>`;
                });

                if (vdoms.length === 0) {
                    // Check for direct interfaces (no vdom node?)
                    // OR just say no VDOMs
                    html += '<li class="list-group-item border-0 text-muted small">No VDOMs found</li>';
                }

                html += `</ul></li>`;
            });
            html += '</ul>';
        });

        html += '</div>';
        container.innerHTML = html;
        container.style.backgroundColor = '#ffffff'; // White background for text
    }

    // Auto-load topology when tab is shown
    document.getElementById('topology-tab')?.addEventListener('shown.bs.tab', () => {
        // Prevent re-loading if already created (avoids duplicated canvases or reset positions)
        if (topologyViewMode === 'graphic' && !topologyNetwork) {
            loadTopology();
        } else if (topologyViewMode === 'text' && document.getElementById('topology-network').innerHTML === '') {
            loadTopology();
        }
    });

    // --- New Policies Logic ---
    async function loadSuggestedPolicies() {
        const container = document.getElementById('suggested-policies-container');
        if (!container) return; // Guard clause

        container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div><p>Cargando sugerencias...</p></div>';

        try {
            // Filter specialized for "new_policy" category
            const response = await apiCall('/analyzer/recommendations?category=new_policy');
            if (response.success && response.data && response.data.length > 0) {
                let html = '<div class="row g-3">';
                response.data.forEach(rec => {
                    html += `
                        <div class="col-md-6">
                            <div class="card h-100 border-success shadow-sm">
                                <div class="card-header bg-success text-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                    <span class="badge bg-white text-success">SUGERENCIA</span>
                                    <small class="text-white-50">${new Date(rec.created_at).toLocaleString()}</small>
                                </div>
                                <div class="card-body">
                                    <h6 class="card-title fw-bold">${rec.title}</h6>
                                    <p class="card-text small">${rec.description}</p>
                                    
                                    ${rec.suggested_policy ? `
                                        <div class="bg-light p-2 rounded small font-monospace mb-2 border">
                                            <div><strong>Src:</strong> ${rec.suggested_policy.src_addr || 'any'}</div>
                                            <div><strong>Dst:</strong> ${rec.suggested_policy.dst_addr || 'any'}</div>
                                            <div><strong>Svc:</strong> ${rec.suggested_policy.service || 'any'}</div>
                                            <div><strong>Action:</strong> <span class="text-success fw-bold">${rec.suggested_policy.action || 'ACCEPT'}</span></div>
                                        </div>
                                    ` : ''}

                                    ${rec.cli_remediation ? `
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#cli-${rec.id}">
                                                <i class="bi bi-terminal me-2"></i>Ver Configuración CLI
                                            </button>
                                            <div class="collapse mt-2" id="cli-${rec.id}">
                                                <div class="bg-dark p-2 rounded position-relative">
                                                     <button class="btn btn-sm btn-link text-white position-absolute top-0 end-0" onclick="navigator.clipboard.writeText(this.nextElementSibling.innerText)">
                                                        <i class="bi bi-clipboard"></i>
                                                    </button>
                                                    <pre class="mb-0 text-success small" style="white-space: pre-wrap;">${rec.cli_remediation}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-check-circle fs-1 mb-3 d-block text-success"></i>
                        <p>No hay nuevas políticas sugeridas pendientes.</p>
                        <small>Ejecute nuevo análisis para generar sugerencias.</small>
                    </div>`;
            }
        } catch (e) {
            container.innerHTML = `<div class="alert alert-danger">Error cargando sugerencias: ${e.message}</div>`;
        }
    }

    // Auto-load new policies tab
    document.getElementById('new-policies-tab')?.addEventListener('shown.bs.tab', loadSuggestedPolicies);


    // --- Topology Analysis ---
    async function analyzeTopology() {
        const siteId = document.getElementById('topology-site-filter').value;
        if (!confirm("Esto enviará la estructura de la topología al motor de IA para buscar ineficiencias y riesgos. ¿Continuar?")) return;

        const btn = document.querySelector('button[onclick="analyzeTopology()"]');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analizando...';
        }

        try {
            const response = await apiCall('/analyzer/analyze/topology', 'POST', JSON.stringify({ site_id: siteId }));

            if (response.success) {
                // Refresh topology to show any new insights (e.g. if we add visual indicators later)
                // For now, it ensures the graph is up to date
                loadTopology();

                alert("Análisis de topología completado.");

                if (confirm("Se han generado nuevas sugerencias de políticas basadas en Zero Trust. ¿Desea revisarlas ahora en la pestaña de Políticas?")) {
                    // Switch to New Policies tab
                    const triggerEl = document.querySelector('#new-policies-tab');
                    if (triggerEl) {
                        const tab = new bootstrap.Tab(triggerEl);
                        tab.show();
                        loadSuggestedPolicies();
                    }
                }
            } else {
                alert("Error: " + response.error);
            }
        } catch (e) {
            alert("Error ejecutando análisis: " + e.message);
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-magic"></i> Analizar';
            }
        }
    }

</script>
{% endblock %}