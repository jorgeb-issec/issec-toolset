{% extends 'layout.html' %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Equipos</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-success me-2" data-bs-toggle="modal"
            data-bs-target="#importDeviceModal">
            <i class="bi bi-upload"></i> Importar (Config)
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
            data-bs-target="#addDeviceModal">
            Nuevo Equipo
        </button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Hostname</th>
                <th>Serial</th>
                <th>Sitio</th>
                <th>HA</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td>{{ device.nombre }}</td>
                <td>{{ device.hostname }}</td>
                <td>{{ device.serial }}</td>
                <td>{{ device.site.nombre if device.site else '-' }}</td>
                <td>{{ 'Sí' if device.ha_habilitado else 'No' }}</td>
                <td>
                    <a href="{{ url_for('device.view_device', device_id=device.id) }}"
                        class="btn btn-sm btn-info text-white" title="Ver Detalles">
                        <i class="bi bi-eye"></i>
                    </a>
                    <form action="{{ url_for('device.delete_device', device_id=device.id) }}" method="POST"
                        onsubmit="return confirm('¿Seguro que desea eliminar este equipo?');" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Add Device -->
<div class="modal fade" id="addDeviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('device.add_device') }}" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Nuevo Equipo Manualmente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="hostname" class="form-label">Hostname</label>
                        <input type="text" class="form-control" id="hostname" name="hostname">
                    </div>
                    <div class="mb-3">
                        <label for="serial" class="form-label">Serial Number</label>
                        <input type="text" class="form-control" id="serial" name="serial" required>
                    </div>
                    <div class="mb-3">
                        <label for="site_id" class="form-label">Sitio</label>
                        <select class="form-select" id="site_id" name="site_id" required>
                            <option value="">Seleccionar...</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}">{{ site.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="ha_habilitado" name="ha_habilitado">
                        <label class="form-check-label" for="ha_habilitado">Habilitar HA</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Import Device -->
<div class="modal fade" id="importDeviceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('device.import_device_config') }}" method="POST" enctype="multipart/form-data">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Importar desde Configuración</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="config_file" class="form-label">Archivo .conf</label>
                        <input class="form-control" type="file" id="config_file" name="config_file" required>
                    </div>
                    <div class="mb-3">
                        <label for="import_site_id" class="form-label">Asignar a Sitio</label>
                        <select class="form-select" id="import_site_id" name="site_id" required>
                            <option value="">Seleccionar...</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}">{{ site.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="serial_number" class="form-label">Serial Number (Opcional)</label>
                        <input type="text" class="form-control" id="serial_number" name="serial_number" 
                               placeholder="Ej: FG200G1234567890">
                        <small class="form-text text-muted">
                            Deje en blanco para que el sistema intente extraerlo del archivo. 
                            Si no se encuentra, se generará uno temporal.
                        </small>
                    </div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> El sistema intentará extraer el Hostname, Serial y VDOMs del archivo de configuración.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Importar</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}