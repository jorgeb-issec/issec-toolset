{% extends 'layout.html' %}
{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-person-gear"></i> Roles de: {{ user.username }}</h2>
        <a href="{{ url_for('main.list_users') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver a Usuarios
        </a>
    </div>
    <div class="col-12">
        <p class="text-muted">{{ user.full_name or '' }} - {{ user.email }}</p>
    </div>
</div>

<div class="row">
    <!-- List of Current Roles -->
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">Roles Asignados</h5>
            </div>
            <div class="card-body">
                {% if assignments %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Rol</th>
                                <th>Ámbito (Scope)</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assign in assignments %}
                            <tr>
                                <td class="fw-bold">
                                    <span class="badge bg-primary">{{ assign.role_name }}</span>
                                </td>
                                <td>
                                    {% if assign.is_global %}
                                    <span class="badge bg-success">GLOBAL / Todas las Empresas</span>
                                    {% else %}
                                    <span class="badge bg-light text-dark border"><i class="bi bi-building"></i> {{
                                        assign.scope }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <form
                                        action="{{ url_for('user_role.delete_user_role', user_id=user.id, assignment_id=assign.row_id) }}"
                                        method="POST" onsubmit="return confirm('¿Quitar este rol?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i> Quitar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">Este usuario no tiene roles asignados.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Assign New Role -->
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-light">
                <h5 class="mb-0">Asignar Nuevo Rol</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('user_role.add_user_role', user_id=user.id) }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <select name="role_id" class="form-select" required>
                            <option value="">Seleccione Rol...</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ámbito / Empresa</label>
                        <select name="company_id" class="form-select" required>
                            <option value="global" class="fw-bold">Global (Todas las Empresas)</option>
                            <option disabled>──────</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text small">
                            Seleccione "Global" para dar acceso a todas las empresas, o seleccione una empresa
                            específica.
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Asignar Rol</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}